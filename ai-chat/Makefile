# ========================================
# AI Chat ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - Makefile
# ========================================

.PHONY: help install setup dev build start deploy clean test lint prisma-generate prisma-push prisma-studio env-check

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
help:
	@echo "========================================="
	@echo "AI Chat ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰"
	@echo "========================================="
	@echo ""
	@echo "ğŸ“¦ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—:"
	@echo "  make install          - ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo "  make setup            - åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆinstall + prisma-generate + prisma-pushï¼‰"
	@echo "  make env-check        - ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª"
	@echo ""
	@echo "ğŸ—„ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:"
	@echo "  make prisma-generate  - Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆ"
	@echo "  make prisma-push      - Prismaã‚¹ã‚­ãƒ¼ãƒã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ "
	@echo "  make prisma-studio    - Prisma Studioã‚’èµ·å‹•ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹GUIï¼‰"
	@echo "  make db-reset         - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ"
	@echo ""
	@echo "ğŸš€ é–‹ç™º:"
	@echo "  make dev              - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆlocalhost:3000ï¼‰"
	@echo "  make dev-https        - HTTPSé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
	@echo ""
	@echo "ğŸ—ï¸  ãƒ“ãƒ«ãƒ‰:"
	@echo "  make build            - æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰ã‚’ä½œæˆ"
	@echo "  make start            - æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
	@echo ""
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆ:"
	@echo "  make test             - ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  make test-watch       - ãƒ†ã‚¹ãƒˆã‚’ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ"
	@echo "  make test-coverage    - ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ"
	@echo "  make lint             - ESLintã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯"
	@echo "  make lint-fix         - ESLintã§è‡ªå‹•ä¿®æ­£"
	@echo ""
	@echo "â˜ï¸  ãƒ‡ãƒ—ãƒ­ã‚¤:"
	@echo "  make deploy           - Vercelã«æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make deploy-preview   - Vercelã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤"
	@echo "  make vercel-login     - Vercel CLIã«ãƒ­ã‚°ã‚¤ãƒ³"
	@echo "  make vercel-env       - Vercelç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š"
	@echo ""
	@echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—:"
	@echo "  make clean            - ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"
	@echo "  make clean-all        - ã™ã¹ã¦ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤"
	@echo ""
	@echo "ğŸ“ ãã®ä»–:"
	@echo "  make git-commit       - å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ"
	@echo "  make git-push         - GitHubã«ãƒ—ãƒƒã‚·ãƒ¥"
	@echo ""

# ========================================
# ğŸ“¦ åˆæœŸã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
# ========================================

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
install:
	@echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
	npm install
	@echo "âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†"

# åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆã™ã¹ã¦ã®åˆæœŸåŒ–å‡¦ç†ï¼‰
setup: install prisma-generate prisma-push
	@echo ""
	@echo "ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"
	@echo ""
	@echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
	@echo "  1. .env ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š"
	@echo "  2. make dev ã§é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•"
	@echo ""

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
env-check:
	@echo "ğŸ” ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªä¸­..."
	@if [ ! -f .env ]; then \
		echo "âš ï¸  .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"; \
		echo ""; \
		echo ".env.example ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ .env ã‚’ä½œæˆã—ã¦ãã ã•ã„:"; \
		echo "  cp .env.example .env"; \
		echo ""; \
		exit 1; \
	fi
	@echo "âœ… .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™"
	@echo ""
	@echo "è¨­å®šã•ã‚Œã¦ã„ã‚‹ç’°å¢ƒå¤‰æ•°:"
	@grep -v '^#' .env | grep -v '^$$' || true

# ========================================
# ğŸ—„ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
# ========================================

# Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆ
prisma-generate:
	@echo "ğŸ”§ Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ç”Ÿæˆä¸­..."
	npx prisma generate
	@echo "âœ… Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”Ÿæˆå®Œäº†"

# Prismaã‚¹ã‚­ãƒ¼ãƒã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ 
prisma-push:
	@echo "ğŸ“¤ Prismaã‚¹ã‚­ãƒ¼ãƒã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ ä¸­..."
	npx prisma db push
	@echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åæ˜ å®Œäº†"

# Prisma Studioã‚’èµ·å‹•
prisma-studio:
	@echo "ğŸ¨ Prisma Studioã‚’èµ·å‹•ä¸­..."
	@echo "ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:5555 ã‚’é–‹ã„ã¦ãã ã•ã„"
	npx prisma studio

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
db-reset:
	@echo "âš ï¸  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ï¼ˆã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ï¼‰"
	@read -p "ç¶šè¡Œã—ã¾ã™ã‹? [y/N] " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		npx prisma db push --force-reset; \
		echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆå®Œäº†"; \
	else \
		echo "âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ"; \
	fi

# ========================================
# ğŸš€ é–‹ç™º
# ========================================

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
dev: env-check
	@echo "ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
	@echo "ã‚¢ã‚¯ã‚»ã‚¹: http://localhost:3000"
	npm run dev

# HTTPSé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
dev-https:
	@echo "ğŸ”’ HTTPSé–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
	@echo "ã‚¢ã‚¯ã‚»ã‚¹: https://localhost:3000"
	npm run dev -- --experimental-https

# ========================================
# ğŸ—ï¸  ãƒ“ãƒ«ãƒ‰
# ========================================

# æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰ã‚’ä½œæˆ
build: env-check
	@echo "ğŸ—ï¸  æœ¬ç•ªç”¨ãƒ“ãƒ«ãƒ‰ã‚’ä½œæˆä¸­..."
	npm run build
	@echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

# æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•
start:
	@echo "ğŸš€ æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
	@echo "ã‚¢ã‚¯ã‚»ã‚¹: http://localhost:3000"
	npm start

# ========================================
# ğŸ§ª ãƒ†ã‚¹ãƒˆ
# ========================================

# ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
test:
	@echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	npm test

# ãƒ†ã‚¹ãƒˆã‚’ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œ
test-watch:
	@echo "ğŸ‘€ ãƒ†ã‚¹ãƒˆã‚’ã‚¦ã‚©ãƒƒãƒãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œä¸­..."
	npm test -- --watch

# ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
test-coverage:
	@echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ä»˜ãã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
	npm test -- --coverage

# ESLintã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
lint:
	@echo "ğŸ” ESLintã§ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
	npm run lint

# ESLintã§è‡ªå‹•ä¿®æ­£
lint-fix:
	@echo "ğŸ”§ ESLintã§è‡ªå‹•ä¿®æ­£ä¸­..."
	npx eslint . --fix

# ========================================
# â˜ï¸  ãƒ‡ãƒ—ãƒ­ã‚¤
# ========================================

# Vercel CLIã«ãƒ­ã‚°ã‚¤ãƒ³
vercel-login:
	@echo "ğŸ” Vercel CLIã«ãƒ­ã‚°ã‚¤ãƒ³ä¸­..."
	vercel login

# Vercelç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
vercel-env:
	@echo "âš™ï¸  Vercelç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™"
	@echo ""
	@echo "ä»¥ä¸‹ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„:"
	@echo "  - GOOGLE_GENERATIVE_AI_API_KEY"
	@echo "  - DATABASE_URL"
	@echo "  - NEXT_PUBLIC_APP_URL"
	@echo ""
	@echo "ã‚³ãƒãƒ³ãƒ‰:"
	@echo "  vercel env add GOOGLE_GENERATIVE_AI_API_KEY"
	@echo "  vercel env add DATABASE_URL"
	@echo "  vercel env add NEXT_PUBLIC_APP_URL"
	@echo ""
	@read -p "ç’°å¢ƒå¤‰æ•°è¨­å®šã‚’é–‹å§‹ã—ã¾ã™ã‹? [y/N] " confirm; \
	if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
		vercel env add GOOGLE_GENERATIVE_AI_API_KEY; \
		vercel env add DATABASE_URL; \
		vercel env add NEXT_PUBLIC_APP_URL; \
		echo "âœ… ç’°å¢ƒå¤‰æ•°è¨­å®šå®Œäº†"; \
	else \
		echo "æ‰‹å‹•ã§è¨­å®šã—ã¦ãã ã•ã„"; \
	fi

# Vercelã«æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
deploy: build
	@echo "â˜ï¸  Vercelã«æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	vercel --prod --yes
	@echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

# Vercelã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤
deploy-preview:
	@echo "ğŸ‘€ Vercelã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­..."
	vercel --yes
	@echo "âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"

# ========================================
# ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
# ========================================

# ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
clean:
	@echo "ğŸ§¹ ãƒ“ãƒ«ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­..."
	rm -rf .next
	rm -rf .vercel
	rm -rf out
	@echo "âœ… ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"

# ã™ã¹ã¦ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
clean-all: clean
	@echo "ğŸ§¹ ã™ã¹ã¦ã®ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­..."
	rm -rf node_modules
	rm -rf package-lock.json
	@echo "âœ… å®Œå…¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†"
	@echo ""
	@echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: make setup"

# ========================================
# ğŸ“ Gitæ“ä½œ
# ========================================

# å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
git-commit:
	@echo "ğŸ“ å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆä¸­..."
	@read -p "ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: " msg; \
	git add .; \
	git commit -m "$$msg"; \
	echo "âœ… ã‚³ãƒŸãƒƒãƒˆå®Œäº†"

# GitHubã«ãƒ—ãƒƒã‚·ãƒ¥
git-push:
	@echo "ğŸ“¤ GitHubã«ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
	git push origin master
	@echo "âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº†"

# ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
git-sync: git-commit git-push
	@echo "âœ… GitåŒæœŸå®Œäº†"

# ========================================
# ğŸ“Š ä¾¿åˆ©ãªã‚³ãƒãƒ³ãƒ‰
# ========================================

# ã™ã¹ã¦ã®æƒ…å ±ã‚’è¡¨ç¤º
info:
	@echo "========================================="
	@echo "AI Chat ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±"
	@echo "========================================="
	@echo ""
	@echo "ğŸ“¦ Node.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
	@node --version
	@echo ""
	@echo "ğŸ“¦ npm ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
	@npm --version
	@echo ""
	@echo "ğŸ“¦ Next.js ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
	@npx next --version 2>/dev/null || echo "Next.jsæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo ""
	@echo "ğŸ“¦ Vercel CLI ãƒãƒ¼ã‚¸ãƒ§ãƒ³:"
	@vercel --version 2>/dev/null || echo "Vercel CLIæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«"
	@echo ""
	@echo "ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª:"
	@pwd
	@echo ""

# ========================================
# ğŸ”„ å®Œå…¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# ========================================

# é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆåˆå›ï¼‰
workflow-first:
	@echo "ğŸš€ åˆå›é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹..."
	make setup
	make dev

# é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆé€šå¸¸ï¼‰
workflow-dev:
	@echo "ğŸš€ é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹..."
	make install
	make prisma-generate
	make dev

# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
workflow-deploy:
	@echo "ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹..."
	make lint
	make test
	make build
	make deploy
	@echo "âœ… ã™ã¹ã¦å®Œäº†ï¼"
